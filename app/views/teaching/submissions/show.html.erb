<% title 'Grading' %>

<h2>
  <%= current_submission.student.full_name %>'s
  Homework
</h2>

<div class="tip">
  To annotate, select text with your mouse.
</div>


<div id="annotation-margin">
  <textarea id="annotation"></textarea>
  <button id="annotate">Annotate Selection</button>
</div>

<div id="submission-text">
  <%= current_submission.text %>
</div>

<%= form_for :current_submission,
             :url => teaching_submission_path(current_course, current_submission),
             :html => {:method => :put} do %>
  <button id="save-changes">Save changes</button>
<% end %>

<%= javascript_include_tag 'selection', 'annotator' %>

<script>
$(function() {
  var annotator = HW.Annotator(<%= current_submission.annotations.to_json %>);

  function removeWrap(annotation) {
    $('#submission-text .annotation.a_' + annotation.identifier).each(function() {
      jQuery(this).replaceWith(this.childNodes);
    });
  }

  function createWrap(annotation) {
    return function() {
      var span = document.createElement('span');
      span.className = 'annotation a_' + annotation.identifier;
      return span;
    };
  }
  
  $('#annotate').click(function() {
    var annotation = annotator.create($('annotation').val(), HW.selection.text());
    HW.selection.wrap(createWrap(annotation));
  });

  // $('#')
  // $.ajax({
  //   url: url,
  //   type: 'put',
  //   contentType: 'application/json; charset=utf-8',
  //   data: JSON.stringify(filterParams()),
  //   dataType: 'json',
  //   beforeSend: function(request) {
  //     this.headers = {'X-Http-Method-Override': sekretMethod}
  //   },
  //   success: function(data) {
  //     window.location = data.redirect;
  //   },
  //   error: function() {
  //     $('#filter-save').show();
  //     $('#filter-saving').hide();
  //     alert('Something went wrong...');
  //   }
  // });
});
</script>
