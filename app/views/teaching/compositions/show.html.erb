<% title 'Grading' %>

<h2>
  <%= current_submission.student.full_name %>'s
  Homework
</h2>

<div class="tip">
  To annotate, select text with your mouse.
</div>


<div id="annotation-margin">
  <textarea id="annotation"></textarea>
  <p>
    <button id="annotate">Annotate Selection</button>
  </p>
</div>

<%= form_for :current_submission,
             :url => teaching_composition_path(current_course, current_submission),
             :html => {:method => :put, :id => 'annotation-form'} do |f| %>
  <div id="submission-text">
    <%= current_submission.annotated %>
  </div>
  <%= f.submit 'Save changes', :id => 'save-changes' %>
<% end %>

<%= javascript_include_tag 'selection', 'annotator' %>

<script>
$(function() {
  var annotator = HW.Annotator(<%= current_submission.annotations.to_json %>);

  function removeWrap(annotation) {
    $('#submission-text .annotation.a_' + annotation.identifier).each(function() {
      jQuery(this).replaceWith(this.childNodes);
    });
  }

  function createWrap(annotation) {
    return function() {
      var span = document.createElement('span');
      span.className = 'annotation a_' + annotation.identifier;
      return span;
    };
  }
  
  function submitData() {
    return {
      'annotations': annotator.all(),
      'annotated': $('#submission-text').html()
    }
  }
  
  $('#annotate').click(function() {
    var annotation = annotator.create($('annotation').val(), HW.selection.text());
    HW.selection.wrap(createWrap(annotation));
  });

  $('#annotation-form').submit(function(event) {
    event.preventDefault();
    $.ajax({
      'url': this.action,
      'type': 'put',
      'dataType': 'json',
      'data': {'annotation': submitData()},
      beforeSend: function(request) {
        this.headers = {'X-Http-Method-Override': 'put'}
      },
      'success': function(data) {
        alert('lol');
        alert(data.foo);
      },
      'error': function() {
        alert('brokey');
      }
    });
  });
  // $.ajax({
  //   url: url,
  //   type: 'put',
  //   contentType: 'application/json; charset=utf-8',
  //   data: JSON.stringify(filterParams()),
  //   dataType: 'json',
  //   beforeSend: function(request) {
  //     this.headers = {'X-Http-Method-Override': sekretMethod}
  //   },
  //   success: function(data) {
  //     window.location = data.redirect;
  //   },
  //   error: function() {
  //     $('#filter-save').show();
  //     $('#filter-saving').hide();
  //     alert('Something went wrong...');
  //   }
  // });
});
</script>
